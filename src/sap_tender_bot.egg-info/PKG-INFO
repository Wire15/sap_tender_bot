Metadata-Version: 2.4
Name: sap-tender-bot
Version: 0.2.0
Summary: Daily digest bot for SAP/ERP tender notices.
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: requests>=2.32.0
Requires-Dist: python-dateutil>=2.9.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: pandas>=2.2.0
Requires-Dist: streamlit>=1.30.0
Requires-Dist: PyYAML>=6.0.1
Requires-Dist: pypdf>=4.2.0
Requires-Dist: python-docx>=1.1.2
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: ruff>=0.4.0; extra == "dev"

﻿# SAP Tender Digest Bot

A daily digest bot that pulls open CanadaBuys tender notices, filters for SAP/ERP relevance, and (optionally) enriches with Cohere Command R before emailing a summary.

## Scope for v1.0 (what "done" means)
Federal CanadaBuys -> high-precision SAP/ERP opportunity detection -> pursuit-ready briefs -> routed to the right team -> with a feedback loop.

Non-goals for v1.0:
- "All Canadian public sector" coverage. Multi-source is a v1.1/v1.2 story unless bandwidth changes.

## Roadmap to v1.0
Version tiers turn the 1.0 plan into staged, shippable slices. Each tier should be release-ready.

### v0.2 - Engineering foundation
- Package properly (remove sys.path bootstrapping; installable package).
- Console entrypoints: `sap-tender-digest` and `sap-tender-ui`.
- Unify config into a single model (YAML + env overrides) shared by CLI, Streamlit, and scheduler.
- Add `.env.example`, setup docs, and a single "make run" equivalent for PowerShell.
- CI: ruff + pytest.
Acceptance:
- `pip install -e .` then `sap-tender-digest --dry-run` works on a fresh machine.
- CI runs green.

### v0.3 - Data correctness + event semantics
- Introduce SQLite store: `runs`, `tenders`, `decisions`, `feedback` tables.
- Stable `tender_key` that ignores amendment number; track `first_seen`, `last_seen`, `last_amendment_seen`, `last_close_date_seen`.
- Emit explicit events: New tender, Amendment posted, Close date changed, New attachment.
- Digest formatting sections: High confidence (New), High confidence (Updated/Amended), Watchlist, and optional Upcoming closes.
Acceptance:
- Repeated runs only notify on material changes.
- You can keep state without wiping it (support `--since-iso` and `--bootstrap`).

### v0.4 - Precision ranking (the big jump)
- Multi-stage filtering: cheap rules -> semantic ranking -> LLM on top slice.
- Embeddings similarity to curated SAP/ERP intent buckets (ERP modernization, procurement, HR/payroll, integration/data, AMS).
- Explainable scoring: top bucket hit + weighted evidence (UNSPSC IT, ERP hits, transformation signals).
Acceptance:
- Daily output remains comprehensive without missing relevant tenders; high-confidence + watchlist structure still applies.
- Each flag is explainable (rules + semantic bucket hit).

### v0.5 - LLM pursuit briefs (usable output)
- Replace "relevance + bullets" with a structured pursuit brief JSON.
- Include opportunity category, SAP solution fit, key requirements, stakeholder entities, timeline, competitive signals, and recommended next steps.
- Cost controls: enrich only high-confidence + thresholded watchlist; daily cap; cache by `tender_key` + amendment.
Acceptance:
- Each item reads like a mini pursuit memo, not a generic summary.

### v0.6 - Attachment/document understanding (selective)
- Selective ingestion: high-confidence only, PDF first, size/page/seconds limits.
- Extract scope, mandatory criteria, submission instructions, key dates, named systems/vendors.
- Feed excerpts into the LLM brief.
Acceptance:
- Vague tender descriptions still produce useful scope in the brief.

### v0.7 - Workflow + feedback loop
- Streamlit review queue: Relevant / Not relevant / Unsure.
- Tag why (false-positive category) and route to team dropdown.
- Persist feedback to SQLite and generate a weekly report (precision estimate, false-positive drivers, suggested tweaks).
Acceptance:
- You can show precision improvement over time with real data.

### v0.8 - Observability + reliability
- Run records: start/end time, duration, counts, cache hits, errors.
- Alerts: short failure email to ops; health summary line on every digest.
- Security basics: secrets via env/secret store; redact sensitive logs; optional "no LLM" mode.
Acceptance:
- You can prove it ran daily and did not silently fail.

### v0.9 - Hardening + docs
- Data migration notes (JSON state -> SQLite), backfill guidance, and test fixtures.
- Performance budgets (time, cost, attachment parsing limits).
- Full runbook (ops, troubleshooting, and recovery steps).

### v1.0 - Release
Definition:
- Pulls open CanadaBuys tenders daily.
- Detects SAP/ERP opportunities with high precision.
- Produces structured pursuit briefs.
- Routes output (email; Slack/Teams optional).
- Supports review + feedback loop.
- Has basic observability + auditability.
- Packaged and deployable reliably.

## KPI targets (lightweight)
Track per run and roll up weekly:
- Coverage/recall: percent of relevant tenders captured (target >= 95% by v0.7).
- Precision: relevant / (relevant + not relevant) on reviewed items (target >= 60% by v0.7).
- Missed-tender rate: relevant tenders discovered later that were not flagged (target <= 5% by v0.7).
- Time to digest: total run minutes (target <= 15 min by v0.6).
- Cost per run: embeddings + LLM + attachments (target <= $10 by v0.6).
- Failure rate: failed runs / total runs (target <= 2% by v0.8).

## Second pair of eyes: improvements vs the last plan
- Add an evaluation dataset and a precision metric target early (before v0.4) to validate ranking changes.
- Plan a clean migration path from JSON state to SQLite (with a one-time backfill script).
- Define a cost and latency budget per run (embeddings + LLM + attachments) to keep scaling predictable.
- Make a "no LLM" path a first-class mode to support sensitive customers and cost control.
- Add a small set of golden tests for event detection (amendments, close-date changes, new attachments).
- Call out the ranking objective explicitly: "maximize recall while improving precision without missing relevant tenders."

## Current status (v0.3, as of 2026-01-26)
- **Ingest:** CanadaBuys “Open tender notices” via CKAN; normalized fields include EN/FR titles/descriptions, dates, orgs, UNSPSC/GSIN, and URLs.
- **Caching:** Conditional GET with ETag/Last‑Modified to avoid re‑downloading unchanged CKAN resources.
- **Delta semantics:** Uses `updated_at = max(publicationDate, amendmentDate)` in the connector; daily digest compares to the SQLite store (`data/sap_tender.db`).
- **State + events:** Stable `tender_key` (ignores amendment number) with per‑tender `first_seen`, `last_seen`, `last_amendment_seen`, `last_close_date_seen`; events emitted for New, Amendment, Close date change, and New attachment. Only material changes trigger notifications.
- **Filtering:** Heavily tuned to remove supply arrangements/standing offers, staffing, goods/hardware, non‑IT services, and portal boilerplate. Accent/apostrophe normalization is in place. Explainability is stored on each tender (`_hits`).
- **LLM:** Cohere Command R integration with retries and cache (`data/cache/llm/`).
- **Email:** SMTP HTML digest with optional CSV attachment. Dry‑run writes HTML to `data/exports/`. Digest sections: High confidence (New), High confidence (Updated/Amended), Watchlist, and optional Upcoming closes (next 7 days).
- **Watchlist:** Optional near‑miss section in the email for single‑reason rejects.
- **Logging:** File logging at `logs/run_YYYYMMDD.log`.
- **Result snapshot:** With the current (tight) filters, the latest dry runs found **0** relevant open tenders. This is expected when the dataset has no SAP/ERP opportunities.

## Repo layout
```
src/
  sap_tender_bot/
    connectors/
      canadabuys_tender_notices.py # CKAN download + normalization
      open_canada_ckan.py          # CKAN client
    pipeline/
      ingest.py                    # connector wrapper
      filter.py                    # scoring + filters
      llm.py                       # Cohere Command R integration + cache
      notify_email.py              # SMTP HTML email
    daily_digest.py                # main runner
    cli.py                         # lightweight CLI
    config.py                      # config model + YAML loading
    ui.py                          # streamlit launcher
streamlit_app.py                   # Streamlit entrypoint
ui_common.py                       # Streamlit helpers
pages/                             # Streamlit multipage views
config.yaml                        # YAML config (source of truth)
```

## Setup (fresh machine)
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -e .[dev]
copy .env.example .env
```
Edit `config.yaml` and `.env` as needed.
Dependencies are managed in `pyproject.toml` (the `requirements.txt` file is a convenience pointer).

## Usage
Dry run (no email, no state update):
```powershell
sap-tender-digest --dry-run --export-csv --no-llm
```

Dev exports (near-miss + reject report). Near-miss includes only single-reason rejects:
```powershell
sap-tender-digest --dry-run --export-csv --export-near-miss --export-report --no-llm
```

Production run:
```powershell
sap-tender-digest --export-csv
```

Bootstrap (seed state, no email):
```powershell
sap-tender-digest --bootstrap
```

Backfill:
```powershell
sap-tender-digest --since-iso 2025-12-01T00:00:00Z --export-csv
```

PowerShell helper:
```powershell
.\scripts\run.ps1        # dry run + exports (no LLM)
.\scripts\run.ps1 -Ui    # launch Streamlit UI
```

## Admin UI (Streamlit)
Launch the multi-page admin UI:
```powershell
sap-tender-ui
```

Notes:
- The UI reads from `data/exports/` and `logs/` (state is stored in SQLite).
- Run a dry run export first if the UI is empty:
  ```powershell
  sap-tender-digest --dry-run --export-csv --export-near-miss --export-report --no-llm
  ```

## Attachment enrichment design notes
- **Fingerprinting:** normalized URL + ETag/Last‑Modified when available; fallback to content hash.
- **Cache store:** `attachment_cache` table records meta + summary JSON + provenance.
- **Limits:** per‑run/per‑tender caps and max bytes enforced via `attachments.*` config.
- **Concurrency:** attachment processing uses a worker pool capped by `attachments.download_concurrency`.
- **Extraction:** PDF via `pypdf`, DOCX via `python-docx`; repeated headers/footers stripped.
- **OCR (optional):** if `attachments.ocr_enabled=true` and text is too short, attempt OCR.  
  Requires optional deps (`pdf2image`, `pytesseract`) and system binaries (Poppler + Tesseract).
- **Safety:** MIME validation, size limits, and optional PII scrub before LLM.
- **Runtime override:** disable per run with `sap-tender-digest --no-attachments`.

## Attachment Q&A (planned steps)
High-level steps to add a tender Q&A experience backed by attachment text (with citations):
1) **Persist normalized attachment text**  
   - Save extracted text chunks to disk (e.g., `data/attachments_text/`) and store chunk metadata in SQLite (tender_key, attachment fingerprint, section heading, char offsets).
2) **Chunking + section metadata**  
   - Split by detected headings; fall back to fixed-size chunks (e.g., 500–1,000 chars with overlap).  
   - Keep `section_title`, `page_range` (if available), and `source_url` for citations.
3) **Embeddings index**  
   - Create embeddings for each chunk using the existing embedding model config.  
   - Store vectors in a lightweight store (SQLite + `sqlite-vec`, or file-based parquet + FAISS).  
   - Cache by attachment fingerprint + chunk hash so re-runs are cheap.
4) **Retriever**  
   - Given a question, embed the query and retrieve top‑k chunks (k=5–8).  
   - Filter by tender_key to avoid cross‑tender bleed unless explicitly requested.
5) **Answer prompt with citations**  
   - Provide retrieved chunks + metadata to the LLM.  
   - Require inline citations (e.g., `[Attachment: section/page]`) and an “Unknown” response if evidence is weak.
6) **UI panel**  
   - Add a “Ask a question” box on the Attachments page.  
   - Show answer + citations; allow the user to expand cited chunks.
7) **Safety + cost controls**  
   - Per‑run and per‑query caps; enforce max tokens and timeouts.  
   - Optional PII scrub on chunks before LLM calls.
8) **Tests + acceptance**  
   - Unit test chunking and retrieval (known query returns expected chunk).  
   - Acceptance: answer references correct attachment sections and avoids hallucinations.

## Configuration (config.yaml + .env)
- **YAML source of truth:** `config.yaml` (rules, schedules, sources, paths).
- **Environment overrides:** `.env` or system env (see `.env.example`).

Required for email (env or config):
- `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `EMAIL_TO`, `EMAIL_FROM`

Optional for LLM:
- `COHERE_API_KEY`, `COHERE_MODEL`, `COHERE_API_BASE`, `COHERE_TIMEOUT`

Optional overrides:
- `SAP_TENDER_CONFIG`, `SAP_TENDER_DATA_DIR`, `SAP_TENDER_LOG_DIR`, `SAP_TENDER_CACHE_DIR`
- `SAP_TENDER_DB_PATH`
- `SAP_TENDER_MIN_SCORE_NON_SAP`, `SAP_TENDER_MAX_NON_SAP_CLOSE_DAYS`
- `SAP_TENDER_INCLUDE_STAFFING`, `SAP_TENDER_INCLUDE_SUPPLY_ARRANGEMENTS`
- `SAP_TENDER_SEEN_RETENTION_DAYS`, `SAP_TENDER_WATCHLIST_MAX`, `SAP_TENDER_WATCHLIST_BLOCKLIST`
- `SAP_TENDER_DIGEST_SCHEDULE`, `SAP_TENDER_TIMEZONE`

## State and outputs
- State: `data/sap_tender.db` (tables: runs, tenders, decisions, feedback)
- Exports: `data/exports/flagged_YYYYMMDD.csv`, `data/exports/digest_YYYYMMDD_HHMMSS.html`
- Logs: `logs/run_YYYYMMDD.log`

## Scheduling (Windows Task Scheduler)
```powershell
schtasks /Create /SC DAILY /ST 08:35 /TN "SAP Tender Digest" /TR "cmd /c \"cd /d C:\\dev\\sap-tender-bot && .venv\\Scripts\\sap-tender-digest.exe --config C:\\dev\\sap-tender-bot\\config.yaml --export-csv\""
```
